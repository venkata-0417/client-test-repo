name: Escrow Build

on:
  workflow_dispatch:
    inputs:
      project_type:
        description: 'Project Type'
        required: true
        default: 'react'
        type: choice
        options:
          - angular
          - react
          - nextjs
          - python
          - java
      build_required:
        description: 'Is Build Required?'
        required: true
        default: 'yes'
        type: choice
        options:
          - yes
          - no

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------
      # 1️⃣ Pull Code
      # -----------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------------
      # 2️⃣ Generate Source Checksum (IMMEDIATELY)
      # -----------------------------------
      - name: Generate Source Code Checksum
        run: |
          echo "Generating source checksum after pull..."

          find . -type f \
            ! -path './.git/*' \
            | sort | xargs sha256sum > source_checksum.txt

          cat source_checksum.txt

      # -----------------------------------
      # 3️⃣ Build Section (ONLY IF REQUIRED)
      # -----------------------------------
      - name: Setup Node
        if: ${{ inputs.build_required == 'yes' && (inputs.project_type == 'angular' || inputs.project_type == 'react' || inputs.project_type == 'nextjs') }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Project
        if: ${{ inputs.build_required == 'yes' && (inputs.project_type == 'angular' || inputs.project_type == 'react' || inputs.project_type == 'nextjs') }}
        run: |
          npm ci
          npm run build

      # -----------------------------------
      # 4️⃣ Generate Build Checksum (ONLY IF BUILT)
      # -----------------------------------
      - name: Generate Build Checksum
        if: ${{ inputs.build_required == 'yes' }}
        run: |
          if [ -d "dist" ]; then
            find dist -type f | sort | xargs sha256sum > build_checksum.txt
          elif [ -d "build" ]; then
            find build -type f | sort | xargs sha256sum > build_checksum.txt
          elif [ -d "target" ]; then
            find target -type f | sort | xargs sha256sum > build_checksum.txt
          else
            echo "No build directory found" > build_checksum.txt
          fi

          cat build_checksum.txt

      # -----------------------------------
      # 5️⃣ Upload Artifacts
      # -----------------------------------
      - name: Upload Escrow Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: escrow-${{ github.run_id }}
          path: |
            source_checksum.txt
            build_checksum.txt
