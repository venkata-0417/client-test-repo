name: Escrow Build

on:
  workflow_dispatch:
    inputs:
      project_type:
        description: 'Project Type'
        required: true
        default: 'react'
        type: choice
        options:
          - angular
          - react
          - nextjs
          - python
          - java

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Show Build Info
        run: |
          echo "Project Type : ${{ inputs.project_type }}"
          echo "Commit SHA   : ${{ github.sha }}"
          echo "Run ID       : ${{ github.run_id }}"

      - name: Setup Node
        if: ${{ inputs.project_type == 'angular' || inputs.project_type == 'react' || inputs.project_type == 'nextjs' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build React / Next.js
        if: ${{ inputs.project_type == 'react' || inputs.project_type == 'nextjs' }}
        run: |
          npm ci
          npm run build

      - name: Build Angular
        if: ${{ inputs.project_type == 'angular' }}
        run: |
          npm ci
          npm run build -- --configuration production

      - name: Setup Python
        if: ${{ inputs.project_type == 'python' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build Python
        if: ${{ inputs.project_type == 'python' }}
        run: |
          pip install -r requirements.txt
          echo "Python build done"

      - name: Setup Java
        if: ${{ inputs.project_type == 'java' }}
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Java
        if: ${{ inputs.project_type == 'java' }}
        run: mvn clean package -DskipTests

      - name: Generate Source Code Checksum
        run: |
          echo "Generating source code checksum..."
          find . -type f \
            ! -path './.git/*' \
            ! -path './node_modules/*' \
            ! -path './dist/*' \
            ! -path './build/*' \
            ! -path './target/*' \
            ! -path './.next/*' \
            | sort | xargs sha256sum > source_checksum.txt
          cat source_checksum.txt

      - name: Generate Build Artifact Checksum
        run: |
          echo "Generating build artifact checksum..."

          if [ -d "dist" ]; then
            find dist -type f | sort | xargs sha256sum > build_checksum.txt
          elif [ -d "build" ]; then
            find build -type f | sort | xargs sha256sum > build_checksum.txt
          elif [ -d "target" ]; then
            find target -type f | sort | xargs sha256sum > build_checksum.txt
          elif [ -d ".next" ]; then
            find .next -type f | sort | xargs sha256sum > build_checksum.txt
          else
            echo "No build directory found" > build_checksum.txt
          fi

          cat build_checksum.txt

       - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: escrow-build-${{ github.run_id }}
          path: |
            source_checksum.txt
            build_checksum.txt
          retention-days: 30


---

## PHASE 3 — Create GitHub PAT (Personal Access Token)

This is critical. Go to:
```
GitHub → Settings → Developer Settings
→ Personal Access Tokens → Tokens (classic) → Generate New Token
```

Give it these permissions:
```
✅ repo          → full repo read/write
✅ workflow      → trigger GitHub Actions
✅ read:org      → read org details
```

Set expiry to **90 days** for UAT testing. Copy and save the token immediately.

---

## PHASE 4 — Complete Your Partially Built .NET API

Since your API is partially built, here is what you need to add or verify exists.

### Project Structure You Should Have
```
EscrowApi/
  ├── Controllers/
  │     ├── EscrowController.cs       ← Add this
  ├── Services/
  │     ├── GitService.cs             ← Add this
  │     ├── GitHubActionsService.cs   ← Add this
  ├── Models/
  │     ├── PullCodeRequest.cs        ← Add this
  │     ├── BuildRequest.cs           ← Add this
  ├── appsettings.json                ← Update this
  └── Program.cs                      ← Verify this
